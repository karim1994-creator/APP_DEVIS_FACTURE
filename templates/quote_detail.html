{% extends 'base.html' %}

{% block title %}Détail du devis {{ quote.quote_number }}{% endblock %}

{% block content %}
<div class="container mt-5">

    {# Bloc affichage messages flash #}
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div id="flash-messages" class="mb-4">
          {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
              {{ message }}
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <h1 class="mb-4">Devis {{ quote.quote_number }}</h1>
    <p><strong>Date :</strong> {{ quote.creation_date.strftime('%d/%m/%Y') }}</p>
    <div><strong>Code client :</strong> {{ quote.client.code }}</div>
    <div><strong>Entreprise :</strong> {{ quote.client.company }}</div>
    <p><strong>Client :</strong> {{ quote.client.first_name }} {{ quote.client.last_name }}</p>
    <p><strong>Lieu de livraison :</strong> {{ quote.delivery_location }}</p>

    <h2>Liste des produits du fournisseur "{{ supplier_name }}"</h2>
    <table class="table table-striped table-bordered table-hover">
        <thead class="table-primary">
            <tr>
                <th>Réf. Fourn.</th>
                <th>Désignation</th>
                <th>Quantité</th>
                <th>Prix fournisseur (€)</th>
                <th>Prix vente conseillé (€)</th>
                <th>Prix vente client (€)</th>
                <th>Marge (€)</th>
            </tr>
        </thead>
        <tbody>
            {% for l in lines %}
            <tr>
                <td>{{ l.supplier_ref }}</td>
                <td>{{ l.description }}</td>
                <td>{{ l.quantity }}</td>
                <td class="prix-fournisseur">
                    {% if l.best_price.price is not none %}
                        {{ '%.2f'|format(l.best_price.price) }}
                    {% else %}
                        NA
                    {% endif %}
                </td>
                <td>{{ '%.2f'|format(l.recommended_price or 0) }}</td>
                <td>{{ '%.2f'|format(l.client_price) }}</td>
                <td>
                    {{ '%.2f'|format(l.margin) }} €
                    {% if l.client_price and l.client_price > 0 %}
                        / {{ '%.2f'|format(l.margin / l.client_price * 100) }} %
                    {% else %}
                        / NA %
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
		<tfoot class="table-light fw-bold">
			<tr>
				<td colspan="3" class="text-end">Totaux :</td>
				<td>
					{{ '%.2f'|format(total_fournisseur_with_delivery) }} €
					<div class="text-muted small">
						(incl. livraison : {{ '%.2f'|format(total_delivery_fee) }} €)
					</div>
				</td>
				<td>{{ '%.2f'|format(total_recommended) }} €</td>
				<td>{{ '%.2f'|format(total_client) }} €</td>
				{% if total_client > 0 %}
					<td>{{ '%.2f'|format(total_marge) }} € / {{ '%.2f'|format(total_marge / total_client * 100) }} %</td>
				{% else %}
					<td>{{ '%.2f'|format(total_marge) }} € / NA %</td>
				{% endif %}
			</tr>
		</tfoot>


    <h2>Informations de livraison</h2>
    <table class="table table-bordered">
        <thead class="table-primary">
            <tr>
                <th>Fournisseur</th>
                <th>Délai (j)</th>
                <th>Frais (€)</th>
            </tr>
        </thead>
        <tbody>
            {% for info in supplier_info %}
            <tr>
                <td>{{ supplier_name }}</td>
                <td>{{ info.delivery_delay }}</td>
                <td>{{ '%.2f'|format(info.delivery_fee) }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <a href="{{ url_for('edit_quote', quote_id=quote.id) }}" class="btn btn-warning mt-3 me-2">
        ✎ Modifier / Compléter le devis
    </a>
    <a href="{{ url_for('list_quotes') }}" class="btn btn-outline-primary mt-3">← Retour à la liste des devis</a>
    <br><br>
</div>
{% endblock %}
