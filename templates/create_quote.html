{% extends 'base.html' %}

{% block title %}Cr√©er un devis{% endblock %}

{% block content %}
    <style>
	        .move-header {
        background-color: #E0BBE4  !important;
    }
	
	        .blue-header {
        background-color: #cce5ff  !important;
    }
	th.move-column {
    background-color: #E0BBE4 !important;
}
    
	th.blue-column {
    background-color: #cce5ff !important;
}

        table, th, td {
            border: 1px solid #ccc;
            border-collapse: collapse;
            padding: 6px;
            text-align: center;
        }
        th {
            background-color: #f8f8f8;
        }
        input, select {
            width: 100%;
            box-sizing: border-box;
        }
        .total-cell {
            font-weight: bold;
            background-color: #eef;
        }
        .action-button {
            padding: 6px 12px;
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            margin-bottom: 10px;
        }
        .action-button:hover {
            background-color: #0056b3;
        }
        .action-column {
            background-color: #f0f0f0;
            padding: 15px;
            margin-top: 20px;
            text-align: center;
        }
        input::placeholder {
            font-size: 0.85em;
            color: #888;
        }
        /* Vert clair pour case min prix et d√©lai livraison */
        .best-cell {
            background-color: #90ee90 !important;
        }
    </style>
</head>
<body>

<h1>Cr√©er un devis</h1>

<form method="POST" action="/create_quote">
<label for="quote_mode" style="background-color: #FFD580;">Num√©ro de devis :</label>
<select id="quote_mode" onchange="toggleQuoteNumberInput()" style="width: auto; display: inline-block;">
    <option value="auto" selected>-- Auto --</option>
    <option value="manual">-- Saisi --</option>
</select>

<input type="text" name="quote_number" id="quote_number_input" value="{{ quote_number }}" readonly style="width: 250px; display: inline-block; margin-left: 10px;">
<br><br>


<label for="creation_date" style="background-color: #FFD580;">Date de cr√©ation :</label>
<input type="text" name="creation_date" id="creation_date" readonly><br><br>

<label for="client_code" style="background-color: #FFD580;">Client :</label>
<select name="client_code" id="client_code" required onchange="updateDeliveryLocation()">
    {% for client in clients %}
        <option value="{{ client.code }}" 
            data-address="{{ client.address or '' }}" 
            data-registred_office="{{ client.registred_office or '' }}"
            {% if client.code == selected_client_code %}selected{% endif %}>
            {{ client.code }} : {{ client.company }}
        </option>
    {% endfor %}
</select><br><br>


<label for="delivery_location" style="background-color: #FFD580;">Lieu de livraison :</label>
<select name="delivery_location" id="delivery_location"></select><br><br>

<label for="supplier_select" style="background-color: #FFD580;">Ajouter un fournisseur :</label>
<select id="supplier_select">
    <option value="">-- Choisir un fournisseur √† ajouter --</option>
    {% for supplier in suppliers %}
        <option value="{{ supplier.code }}" data-name="{{ supplier.company }}">{{ supplier.code }} : {{ supplier.company }}</option>
    {% endfor %}
</select>
<button type="button" onclick="addSupplierColumn()">Ajouter le fournisseur</button><br><br>

<label for="supplier_remove_select">Supprimer un fournisseur :</label>
<select id="supplier_remove_select">
    <option value="">-- Choisir un fournisseur √† supprimer --</option>
</select>
<button type="button" onclick="removeSelectedSupplier()">Supprimer le fournisseur</button><br><br>

<!-- Conteneur scroll horizontal -->
<div style="overflow-x: auto; width: 100%;">
    <table id="quote_table" style="min-width: 1200px; border-collapse: collapse;">
        <thead>
            <tr id="header_row">
                <th class="blue-column">R√©f. Fourn.</th>
                <th class="move-column">D√©signation</th>
                <th class="blue-column">Quantit√©</th>
                <th class="client-pvc-column" style="background-color: #E0BBE4;">Prix de vente conseill√©</th>
				<th style="background-color: #cce5ff;">Prix de vente client</th>
                <th style="background-color: #FFD580;">Marge (‚Ç¨ / %)</th> 
                <th>Supprimer</th>
            </tr>
        </thead>
        <tbody id="table_body"></tbody>
        <tfoot>
            <tr id="totals_row">
                <td colspan="3" style="font-weight: bold;">Totaux Fournisseurs</td>
                <!-- Ici seront ins√©r√©s dynamiquement les totaux fournisseurs -->
                <td id="total_pvc" class="total-cell"></td>
                <td id="total_vente_client" class="total-cell"></td>
                <td id="total_marge" class="total-cell"></td>
            </tr>
        </tfoot>
    </table>
</div>
<button type="button" onclick="addRow()">Ajouter une ligne</button><br><br>
<label for="selected_supplier_margin">Calculer la marge pour :</label>
<select id="selected_supplier_margin" onchange="updateTotals()">
    <option value="">-- Tous les fournisseurs --</option>
</select><br><br>


<h3>Informations Livraison Fournisseurs</h3>
<table id="supplier_info_table">
    <thead>
        <tr>
            <th>Fournisseur</th>
			<th class="move-column">D√©lai de livraison (j)</th>
			<th class="move-column">Frais de livraison (‚Ç¨)</th>
            <th>Supprimer</th>
        </tr>
    </thead>
    <tbody id="supplier_info_body"></tbody>
</table><br>

<div style="text-align: center; margin-top: 20px;">
    <input type="submit" class="action-button" value="Cr√©er le devis">
</div>

</form>

<script>
{#
    Script JavaScript pour la gestion dynamique du formulaire de cr√©ation de devis

    1. Gestion des fournisseurs s√©lectionn√©s
       - selectedSuppliers : tableau global contenant les fournisseurs ajout√©s
       - addSupplierColumn() / addSupplierColumnById(id, name) :
           * Ajoute une colonne pour un fournisseur s√©lectionn√©
           * Cr√©e les champs prix, remises (% et ‚Ç¨), date de validit√© promo, quantit√© en stock
           * Met √† jour le header et le footer (totaux)
           * Ajoute une ligne dans le tableau "Informations Livraison Fournisseurs"
       - removeSupplier(id) :
           * Supprime un fournisseur et toutes ses colonnes associ√©es
           * Met √† jour le tableau et le select de suppression
       - updateSupplierRemoveSelect() :
           * Met √† jour le select pour choisir un fournisseur √† supprimer
       - removeSelectedSupplier() : supprime le fournisseur s√©lectionn√© dans le select
       - getSupplierNameById(id) : retourne le nom d‚Äôun fournisseur depuis son ID

    2. Gestion des lignes de devis
       - addRow() : ajoute dynamiquement une ligne de produit avec :
           * R√©f√©rence fournisseur, d√©signation, quantit√©
           * Prix conseill√© et prix client
           * Colonnes pour chaque fournisseur s√©lectionn√© (prix + remises + stock + date promo)
           * Cellule de marge
           * Bouton pour supprimer la ligne
       - deleteRow(button) : supprime une ligne et met √† jour les totaux
       - rebuildTable() : permet de reconstruire le tableau si n√©cessaire (apr√®s suppression de colonnes)

    3. Gestion des lieux de livraison
       - updateDeliveryLocation() :
           * Met √† jour le select "Lieu de livraison" selon le client choisi
           * Inclut adresse principale, si√®ge enregistr√©, et option par d√©faut "Linas"

    4. Calcul des totaux et marges
       - updateTotals() :
           * Calcule les totaux pour chaque fournisseur (prix apr√®s remises + frais de livraison)
           * Calcule les totaux PVC, prix client et marge (‚Ç¨ / %)
           * Met √† jour les cellules de marge et les totaux dans le footer
           * Appelle highlightBestPriceSupplier() et highlightBestDelivery() pour surligner les meilleures offres

    5. Surlignage des meilleures offres
       - highlightBestPriceSupplier() :
           * Identifie le fournisseur avec le prix total le plus bas
           * Surligne ses cellules et sa cellule total en vert
           * Supprime le surlignage pour les autres fournisseurs
       - highlightBestDelivery() :
           * Surligne en vert la ligne correspondante dans le tableau "Informations Livraison Fournisseurs"
           * Bas√© sur le fournisseur ayant le prix total le plus bas

    6. Navigation au clavier
       - Permet de passer automatiquement √† l‚Äôinput suivant dans un tbody en appuyant sur Entr√©e
       - Appliqu√© sur :
           * Le tableau principal (table_body)
           * Le tableau "Livraison Fournisseurs" (supplier_info_body)
       - Les changements sur les frais de livraison d√©clenchent updateTotals() pour recalculer les totaux

    7. Gestion du num√©ro de devis
       - toggleQuoteNumberInput() :
           * Mode "auto" : champ en lecture seule, valeur g√©n√©r√©e automatiquement
           * Mode "manual" : champ editable et vide, pr√™t √† √™tre rempli par l‚Äôutilisateur

    8. Fonctions d‚Äôexport (placeholders)
       - createWord() : fonction √† impl√©menter pour cr√©er un fichier Word
       - exportEvoliz() : fonction √† impl√©menter pour exporter vers Evoliz

    9. Initialisation au chargement de la page
       - updateDeliveryLocation() : met √† jour le lieu de livraison selon le client par d√©faut
       - addRow() : ajoute une premi√®re ligne de devis
       - updateTotals() : calcule les totaux initiaux
       - D√©finit la date de cr√©ation au format JJ/MM/AAAA
#}

let selectedSuppliers = [];

function updateDeliveryLocation() {
    const clientSelect = document.getElementById('client_code');
    const address = clientSelect.options[clientSelect.selectedIndex]?.dataset.address || '';
	const registred_office = clientSelect.options[clientSelect.selectedIndex]?.dataset.registred_office || '';
    const deliverySelect = document.getElementById('delivery_location');
    deliverySelect.innerHTML = '';

    if (address) {
        const option1 = document.createElement('option');
        option1.value = address;
        option1.textContent = address;
        deliverySelect.appendChild(option1);
    }
    if (registred_office) {
        const option2 = document.createElement('option');
        option2.value = registred_office;
        option2.textContent = registred_office;
        deliverySelect.appendChild(option2);
    }
    const option3 = document.createElement('option');
    option3.value = 'Linas';
    option3.textContent = 'Linas';
    deliverySelect.appendChild(option3);

    deliverySelect.value = address;
}
function addRow() {
    const tr = document.createElement('tr');
    let supplierCells = '';

    selectedSuppliers.forEach(s => {
       supplierCells += `
<td>
    <div style="overflow-x: auto; min-width: 220px; max-width: 250px; display: block;">
        <div style="display: flex; flex-direction: column;">

            <!-- Prix fournisseur -->
           Prix fournisseur: <input type="number" name="supplier_price_${s.id}[]" step="0.01" placeholder="Prix ‚Ç¨" value="0.00" oninput="updateTotals()">

            
            <!-- Remises -->
            <div style="display: flex; gap: 2px; margin-top: 2px;">
                <input type="number" name="supplier_discount_percent_${s.id}[]" step="0.01" placeholder="Remise %" style="width:50%;" oninput="updateTotals()">
                <input type="number" name="supplier_discount_amount_${s.id}[]" step="0.01" placeholder="Remise ‚Ç¨" style="width:50%;" oninput="updateTotals()">
            </div>
			
            <!-- Prix net -->
            Prix net: <input type="number" name="supplier_net_price_${s.id}[]" step="0.01" placeholder="Prix net ‚Ç¨" value="0.00" readonly style="margin-top:2px; background-color: #FFD580;">

            <!-- Date validit√© promo et quantit√© en stock -->
            <div style="display: flex; flex-direction: column; gap: 2px; margin-top: 2px;">
                <div style="display: flex; align-items: center;">
                    <span style="font-size: 11px; font-weight: 500; white-space: nowrap;">Prix valable jusqu'au :</span>
                    <input type="date" name="supplier_validity_date_${s.id}[]" style="margin-left: auto; width: 50%;" oninput="updateTotals()">
                </div>
                <div style="display: flex; align-items: center;">
                    <span style="font-size: 11px; font-weight: 500; white-space: nowrap;">Quantit√© en stock :</span>
                    <input type="number" name="supplier_stock_${s.id}[]" placeholder="Qt√© stock" style="margin-left: auto; width: 50%;" oninput="updateTotals()">
                </div>
            </div>

        </div>
    </div>
</td>`;
    });

    tr.innerHTML = `
        <td><input type="text" name="supplier_ref[]"  style="width: 150px;"></td>
        <td><textarea name="description[]" style="width:300px;height:80px;font-size:16px;padding:5px;" placeholder="Saisissez la description"></textarea></td>
        <td><input type="number" name="quantity[]" min="1" value="1" oninput="updateTotals()"></td>
        ${supplierCells}
        <td><input type="number" name="recommended_price[]" step="0.01" placeholder="PVC ‚Ç¨" value="0" oninput="updateTotals()"  style="width: 100px;"></td>
        <td><input type="number" name="client_price[]" step="0.01" value="0" oninput="updateTotals()" style="width: 100px;"></td>
        <td class="marge-cell" style="width: 150px;">0.00 ‚Ç¨ / 0.00 %</td>
        <td><button type="button" onclick="deleteRow(this)">üóëÔ∏è</button></td>
    `;
    document.getElementById('table_body').appendChild(tr);
    updateTotals();
}



function addSupplierColumn() {
    const select = document.getElementById('supplier_select');
    const supplierId = select.value;
    const supplierName = select.options[select.selectedIndex]?.dataset.name;
    if (!supplierId || selectedSuppliers.find(s => s.id === supplierId)) return;

    addSupplierColumnById(supplierId, supplierName);
}
function addSupplierColumnById(id, name) {
    if (selectedSuppliers.find(s => s.id === id)) return;
    selectedSuppliers.push({ id: id, name: name });

    const marginSelect = document.getElementById('selected_supplier_margin');
    if (!marginSelect.querySelector(`option[value="${id}"]`)) {
        const option = document.createElement('option');
        option.value = id;
        option.textContent = name;
        marginSelect.appendChild(option);
    }

    const headerRow = document.getElementById('header_row');
    const clientPriceTh = headerRow.querySelector('th.client-pvc-column');

    const newTh = document.createElement('th');
    newTh.setAttribute("colspan", "1");
    newTh.innerHTML = `${name}<br><small>Prix + Remises </small>`;
    newTh.classList.add("move-header");
    headerRow.insertBefore(newTh, clientPriceTh);

    const totalRow = document.getElementById('totals_row');
    const clientTotalCell = totalRow.querySelector('#total_pvc');
    const newTotalTd = document.createElement('td');
    newTotalTd.classList.add('total-cell');
    newTotalTd.id = `total_fournisseur_${id}`;
    totalRow.insertBefore(newTotalTd, clientTotalCell);

    const rows = document.querySelectorAll('#table_body tr');
    rows.forEach(row => {
        const pvcInput = row.querySelector('input[name="recommended_price[]"]');
        const newTd = document.createElement('td');

        const scroller = document.createElement('div');
        scroller.style.overflowX = 'auto';
        scroller.style.minWidth = '220px';
        scroller.style.maxWidth = '250px';
        scroller.style.display = 'block';

        scroller.innerHTML = `
            <div style="display: flex; flex-direction: column;">
                <!-- Prix fournisseur -->
                Prix fournisseur: <input type="number" name="supplier_price_${id}[]" step="0.01" placeholder="Prix ‚Ç¨" value="0.00" oninput="updateTotals()">
                
                <!-- Remises -->
                <div style="display: flex; gap: 2px; margin-top: 2px;">
                    <input type="number" name="supplier_discount_percent_${id}[]" step="0.01" placeholder="Remise %" style="width:50%;" oninput="updateTotals()">
                    <input type="number" name="supplier_discount_amount_${id}[]" step="0.01" placeholder="Remise ‚Ç¨" style="width:50%;" oninput="updateTotals()">
                </div>
                <!-- Prix net -->
                Prix net: <input type="number" name="supplier_net_price_${id}[]" step="0.01" placeholder="Prix net ‚Ç¨" value="0.00" readonly style="background-color: #FFD580; margin-top:2px;">
                <!-- Date validit√© promo et quantit√© en stock -->
                <div style="display: flex; flex-direction: column; gap: 2px; margin-top: 2px;">
                    <div style="display: flex; align-items: center;">
                        <span style="font-size: 11px; font-weight: 500; white-space: nowrap;">Prix valable jusqu'au :</span>
                        <input type="date" name="supplier_validity_date_${id}[]" style="margin-left: auto; width: 50%;" oninput="updateTotals()">
                    </div>
                    <div style="display: flex; align-items: center;">
                        <span style="font-size: 11px; font-weight: 500; white-space: nowrap;">Quantit√© en stock :</span>
                        <input type="number" name="supplier_stock_${id}[]" placeholder="Qt√© stock" style="margin-left: auto; width: 50%;" oninput="updateTotals()">
                    </div>
                </div>
            </div>`;

        newTd.appendChild(scroller);
        row.insertBefore(newTd, pvcInput.closest('td'));
    });

    const supplierInfoBody = document.getElementById('supplier_info_body');
    const trInfo = document.createElement('tr');
    trInfo.dataset.supplierId = id;
    trInfo.innerHTML = `
        <td>${name}</td>
        <td><input type="number" name="delivery_delay_${id}" min="0" value="0" style="width: 60px;" oninput="highlightBestDelivery()"></td>
        <td><input type="number" name="delivery_fee_${id}" min="0" step="0.01" value="0.00" style="width: 80px;" oninput="updateTotals()"></td>
        <td><button type="button" onclick="removeSupplier('${id}')">üóëÔ∏è</button></td>
    `;
    supplierInfoBody.appendChild(trInfo);

    updateSupplierRemoveSelect();
    updateTotals();
    document.querySelector(`input[name="delivery_fee_${id}"]`)?.addEventListener('input', updateTotals);
}





function removeSupplier(id) {
    const supplier = selectedSuppliers.find(s => s.id === id);
    if (!supplier) return;
    const name = supplier.name;
    selectedSuppliers = selectedSuppliers.filter(s => s.id !== id);

    // Supprimer la colonne du header
    const headerRow = document.getElementById('header_row');
    const ths = Array.from(headerRow.children);
    // Trouver la colonne correspondant au fournisseur (colonne dont le texte contient le nom du fournisseur)
    const thToRemove = ths.find(th => th.textContent.trim().startsWith(name));
    const columnIndexToRemove = ths.indexOf(thToRemove);

    if (columnIndexToRemove !== -1) {
        // Supprimer la cellule th du header
        headerRow.removeChild(thToRemove);

        // Supprimer les cellules correspondantes dans chaque ligne du tbody
        const rows = document.querySelectorAll('#table_body tr');
        rows.forEach(row => {
            if (row.children.length > columnIndexToRemove) {
                row.removeChild(row.children[columnIndexToRemove]);
            }
        });

        // Supprimer la cellule de total du fournisseur dans le tfoot
        const totalsRow = document.getElementById('totals_row');
        if (totalsRow && totalsRow.children.length > columnIndexToRemove) {
            totalsRow.removeChild(totalsRow.children[columnIndexToRemove]);
        }
    }

    // Supprimer la ligne d'information fournisseur (d√©lai, frais)
    const supplierInfoBody = document.getElementById('supplier_info_body');
    Array.from(supplierInfoBody.children).forEach(tr => {
        if (tr.dataset.supplierId === id) {
            supplierInfoBody.removeChild(tr);
        }
    });

    // Supprimer l'option du s√©lecteur de marge
    const marginSelect = document.getElementById('selected_supplier_margin');
    const optionToRemove = marginSelect.querySelector(`option[value="${id}"]`);
    if (optionToRemove) {
        marginSelect.removeChild(optionToRemove);
    }

    // Mettre √† jour le s√©lecteur de suppression
    updateSupplierRemoveSelect();

    // Recalculer les totaux
    updateTotals();
}



function updateSupplierRemoveSelect() {
    const removeSelect = document.getElementById('supplier_remove_select');
    removeSelect.innerHTML = '<option value="">-- Choisir un fournisseur √† supprimer --</option>';
    selectedSuppliers.forEach(s => {
        const option = document.createElement('option');
        option.value = s.id;
        option.textContent = s.name;
        removeSelect.appendChild(option);
    });
}

function removeSelectedSupplier() {
    const removeSelect = document.getElementById('supplier_remove_select');
    const id = removeSelect.value;
    if (id) removeSupplier(id);
}

function getSupplierNameById(id) {
    const sup = selectedSuppliers.find(s => s.id === id);
    return sup ? sup.name : id;
}

function deleteRow(button) {
    button.closest('tr').remove();
    updateTotals();
}

function rebuildTable() {
    // Vide le tbody
    const tbody = document.getElementById('table_body');
    tbody.innerHTML = '';

    // Reconstruire les lignes (recr√©ation compl√®te car on a supprim√© une colonne)
    // Ici on pourrait stocker les donn√©es et les re-injecter,
    // mais pour simplifier on part d'un tableau vide
}

function updateTotals() {
    const rows = document.querySelectorAll('#table_body tr');

    // Totaux par fournisseur
    const supplierTotals = {};
    selectedSuppliers.forEach(s => {
        supplierTotals[s.id] = 0;
    });

    let totalVenteClient = 0;
    let totalPVC = 0;
    let totalMarge = 0;

    rows.forEach(row => {
        const qty = parseFloat(row.querySelector('input[name="quantity[]"]').value) || 0;

        const clientPriceInput = row.querySelector('input[name="client_price[]"]');
        const clientPrice = parseFloat(clientPriceInput.value) || 0;
        totalVenteClient += clientPrice * qty;

        const recommendedPriceInput = row.querySelector('input[name="recommended_price[]"]');
        const recommendedPrice = parseFloat(recommendedPriceInput.value) || 0;
        totalPVC += recommendedPrice * qty;

        let bestSupplierPrice = null;
        let bestSupplierId = null;

        selectedSuppliers.forEach(s => {
            const priceInput = row.querySelector(`input[name="supplier_price_${s.id}[]"]`);
            const percentInput = row.querySelector(`input[name="supplier_discount_percent_${s.id}[]"]`);
            const amountInput = row.querySelector(`input[name="supplier_discount_amount_${s.id}[]"]`);
            const netInput = row.querySelector(`input[name="supplier_net_price_${s.id}[]"]`);

            if (!priceInput) return;

            // Lecture des valeurs
            const price = parseFloat(priceInput.value) || 0;
            const discountPercent = parseFloat(percentInput?.value) || 0;
            const discountAmount = parseFloat(amountInput?.value) || 0;

            // Calcul du prix net
            const netPrice = Math.max(0, price - discountAmount - (price * discountPercent / 100));
            if (netInput) netInput.value = netPrice.toFixed(2);

            // Frais de livraison
            const deliveryFeeInput = document.querySelector(`input[name="delivery_fee_${s.id}"]`);
            const deliveryFee = deliveryFeeInput ? parseFloat(deliveryFeeInput.value) || 0 : 0;

            // Quantit√© totale pour ce fournisseur
            let totalQtyForSupplier = 0;
            rows.forEach(r => {
                const q = parseFloat(r.querySelector('input[name="quantity[]"]').value) || 0;
                const p = r.querySelector(`input[name="supplier_price_${s.id}[]"]`);
                if (p) totalQtyForSupplier += q;
            });

            const feePerUnit = totalQtyForSupplier > 0 ? deliveryFee / totalQtyForSupplier : 0;

            // Calcul du total fournisseur
            const unitCostWithDelivery = netPrice + feePerUnit;
            supplierTotals[s.id] += unitCostWithDelivery * qty;

            // D√©termination du meilleur prix
            if (bestSupplierPrice === null || netPrice < bestSupplierPrice) {
                bestSupplierPrice = netPrice;
                bestSupplierId = s.id;
            }
        });

        // Calcul de la marge pour le fournisseur s√©lectionn√©
        const selectedSupplierId = document.getElementById('selected_supplier_margin').value;
        const margeCell = row.querySelector('.marge-cell');

        if (selectedSupplierId && bestSupplierPrice !== null) {
            const priceInput = row.querySelector(`input[name="supplier_price_${selectedSupplierId}[]"]`);
            const percentInput = row.querySelector(`input[name="supplier_discount_percent_${selectedSupplierId}[]"]`);
            const amountInput = row.querySelector(`input[name="supplier_discount_amount_${selectedSupplierId}[]"]`);

            if (priceInput) {
                const price = parseFloat(priceInput.value) || 0;
                const discountPercent = parseFloat(percentInput?.value) || 0;
                const discountAmount = parseFloat(amountInput?.value) || 0;

                const netPrice = Math.max(0, price - discountAmount - (price * discountPercent / 100));

                const deliveryFeeInput = document.querySelector(`input[name="delivery_fee_${selectedSupplierId}"]`);
                const deliveryFee = deliveryFeeInput ? parseFloat(deliveryFeeInput.value) || 0 : 0;

                let totalQtyForSupplier = 0;
                rows.forEach(r => {
                    const q = parseFloat(r.querySelector('input[name="quantity[]"]').value) || 0;
                    const p = r.querySelector(`input[name="supplier_price_${selectedSupplierId}[]"]`);
                    if (p) totalQtyForSupplier += q;
                });

                const feePerUnit = totalQtyForSupplier > 0 ? deliveryFee / totalQtyForSupplier : 0;
                const fullCost = netPrice + feePerUnit;

                const margeValue = clientPrice - fullCost;
                const margePercent = clientPrice > 0 ? (margeValue / clientPrice) * 100 : 0;

                margeCell.textContent = `${margeValue.toFixed(2)} ‚Ç¨ / ${margePercent.toFixed(1)} %`;
                totalMarge += margeValue * qty;
            } else {
                margeCell.textContent = "N/A";
            }
        } else {
            margeCell.textContent = "N/A";
        }
    });

    // Totaux par fournisseur
    selectedSuppliers.forEach(s => {
        const cell = document.getElementById(`total_fournisseur_${s.id}`);
        const feeInput = document.querySelector(`input[name="delivery_fee_${s.id}"]`);
        const deliveryFee = feeInput ? parseFloat(feeInput.value) || 0 : 0;
        if (cell) {
            cell.textContent = `${supplierTotals[s.id].toFixed(2)} ‚Ç¨ (dont ${deliveryFee.toFixed(2)} ‚Ç¨ livraison)`;
        }
    });

    // Totaux g√©n√©raux
    document.getElementById('total_pvc').textContent = totalPVC.toFixed(2) + " ‚Ç¨";
    document.getElementById('total_vente_client').textContent = totalVenteClient.toFixed(2) + " ‚Ç¨";
    document.getElementById('total_marge').textContent = totalMarge.toFixed(2) + " ‚Ç¨";

    highlightBestPriceSupplier();
    highlightBestDelivery();
}



function highlightBestPriceSupplier() {
    // Met en vert la cellule fournisseur avec le prix total le plus bas dans le tableau
    let minTotal = null;
    let minSupplierId = null;
    selectedSuppliers.forEach(s => {
        const totalCell = document.getElementById(`total_fournisseur_${s.id}`);
        if (totalCell) {
            const val = parseFloat(totalCell.textContent) || null;
            if (val !== null && (minTotal === null || val < minTotal)) {
                minTotal = val;
                minSupplierId = s.id;
            }
        }
    });
    // Supprime tous les surlignages
    selectedSuppliers.forEach(s => {
        const rows = document.querySelectorAll(`#table_body tr`);
        rows.forEach(row => {
            const input = row.querySelector(`input[name="supplier_price_${s.id}[]"]`);
            if(input) input.closest('td').classList.remove('best-cell');
        });
        const totalCell = document.getElementById(`total_fournisseur_${s.id}`);
        if(totalCell) totalCell.classList.remove('best-cell');
    });
    if(minSupplierId) {
        // Surligne toutes les cellules de ce fournisseur
        const rows = document.querySelectorAll(`#table_body tr`);
        rows.forEach(row => {
            const input = row.querySelector(`input[name="supplier_price_${minSupplierId}[]"]`);
            if(input) input.closest('td').classList.add('best-cell');
        });
        const totalCell = document.getElementById(`total_fournisseur_${minSupplierId}`);
        if(totalCell) totalCell.classList.add('best-cell');
    }
}
function highlightBestDelivery() {
  const supplierInfoBody = document.getElementById('supplier_info_body');
  if (!supplierInfoBody) return;

  // Trouver le fournisseur qui a la classe 'best-cell' dans la table des prix
  // (on cherche la cellule total du fournisseur dans highlightBestPriceSupplier)
  let bestSupplierId = null;
  selectedSuppliers.forEach(s => {
    const totalCell = document.getElementById(`total_fournisseur_${s.id}`);
    if (totalCell && totalCell.classList.contains('best-cell')) {
      bestSupplierId = s.id;
    }
  });

  // Enlever toutes les couleurs de fond dans supplier_info_body
  [...supplierInfoBody.children].forEach(tr => {
    tr.style.backgroundColor = '';
  });

  if (bestSupplierId) {
    // Surligner en vert le fournisseur qui correspond au bestSupplierId
    const bestTr = supplierInfoBody.querySelector(`tr[data-supplier-id="${bestSupplierId}"]`);
    if (bestTr) bestTr.style.backgroundColor = '#90ee90';
  }
}



function createWord() {
    alert("Fonction Cr√©er un fichier Word √† impl√©menter");
}
function exportEvoliz() {
    alert("Fonction Exporter vers Evoliz √† impl√©menter");
}

document.addEventListener('DOMContentLoaded', () => {
    updateDeliveryLocation();
    addRow();
    updateTotals();
});
// D√©finit la date de cr√©ation au chargement de la page (format AAAA-MM-JJ pour MySQL)
document.addEventListener("DOMContentLoaded", function() {
    const today = new Date();

    const year = today.getFullYear();
    const month = String(today.getMonth() + 1).padStart(2, '0'); // les mois vont de 0 √† 11
    const day = String(today.getDate()).padStart(2, '0');

    const formattedDate = `${year}-${month}-${day}`; // format AAAA-MM-JJ
    document.getElementById("creation_date").value = formattedDate;
});


</script>

<script>
 document.addEventListener('DOMContentLoaded', () => {
  // Fonction commune pour g√©rer la touche Entr√©e dans un tbody donn√©
  function handleEnterKeyOnTable(tbodyId) {
    const tbody = document.getElementById(tbodyId);
    if (!tbody) return;

    tbody.addEventListener('keydown', (event) => {
      if (event.key === 'Enter') {
        event.preventDefault();

        const inputs = Array.from(tbody.querySelectorAll('input, select, textarea'));
        const currentIndex = inputs.indexOf(event.target);

        if (currentIndex > -1) {
          const nextInput = inputs[currentIndex + 1];
          if (nextInput) {
            nextInput.focus();
          }
        }
      }
    });
  }

  // Appliquer sur le tableau principal
  handleEnterKeyOnTable('table_body');

  // Appliquer sur le tableau Livraison Fournisseurs
  handleEnterKeyOnTable('supplier_info_body');

  // √âcouter les modifications des frais de livraison (seulement si > 0)
  document.querySelectorAll('input[name^="delivery_fee_"]').forEach(input => {
    input.addEventListener('input', (e) => {
      const val = parseFloat(e.target.value);
      if (!isNaN(val) && val > 0) {
        updateTotals();
      } else {
        // Si valeur nulle ou vide, on peut forcer la mise √† jour pour retirer la surbrillance
        updateTotals();
      }
    });
  });
});


  function toggleQuoteNumberInput() {
    const mode = document.getElementById('quote_mode').value;
    const input = document.getElementById('quote_number_input');

    if (mode === 'auto') {
        input.readOnly = true;
        input.value = "{{ quote_number }}";
    } else {
        input.readOnly = false;
        input.value = "";  // Champ vide √† remplir manuellement
        input.focus();
    }
}
</script>



</body>
</html>
{% endblock %}
