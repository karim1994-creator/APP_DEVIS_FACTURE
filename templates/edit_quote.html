{% extends 'base.html' %}

{% block title %}Modifier un devis{% endblock %}


{% block content %}
    <style>
	.best-cell {
    background-color: #d4edda !important; /* vert clair */
}

	        .move-header {
        background-color: #E0BBE4  !important;
    }
	
	        .blue-header {
        background-color: #cce5ff  !important;
    }
	th.move-column {
    background-color: #E0BBE4 !important;
}
    
	th.blue-column {
    background-color: #cce5ff !important;
}

        table, th, td {
            border: 1px solid #ccc;
            border-collapse: collapse;
            padding: 6px;
            text-align: center;
        }
        th {
            background-color: #f8f8f8;
        }
        input, select {
            width: 100%;
            box-sizing: border-box;
        }
        .total-cell {
            font-weight: bold;
            background-color: #eef;
        }
        .action-button {
            padding: 6px 12px;
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            margin-bottom: 10px;
        }
        .action-button:hover {
            background-color: #0056b3;
        }
        .action-column {
            background-color: #f0f0f0;
            padding: 15px;
            margin-top: 20px;
            text-align: center;
        }
        input::placeholder {
            font-size: 0.85em;
            color: #888;
        }
        /* Vert clair pour case min prix et d√©lai livraison */
        .best-cell {
            background-color: #90ee90 !important;
        }
    </style>
	<!-- Flatpickr CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

</head
<!-- Flatpickr JS -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<!-- Langue fran√ßaise -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/fr.js"></script>

<body>

<h1>Modifier le devis¬†{{ quote.quote_number }}</h1>
<form method="POST" action="{{ url_for('edit_quote', quote_id=quote.id) }}"> 
    <input type="hidden" name="quote_id" value="{{ quote.id }}">         
    <label for="quote_number" style="background-color: #FFD580;">Num√©ro de devis :</label>
	<input type="text" name="quote_number" id="quote_number" value="{{ quote.quote_number }}" required><br><br>


<label for="creation_date" style="background-color: #FFD580;">Date de cr√©ation :</label>
<input type="text"
       name="creation_date"
       id="creation_date"
       class="form-control"
       value="{{ quote.creation_date.strftime('%Y-%m-%d') }}">
<br>


<label for="client_code" style="background-color: #FFD580;">Client :</label>
<select name="client_code" id="client_code" required onchange="updateDeliveryLocation()">
    {# 1. Ajouter le client s√©lectionn√© en premier #}
    {% if selected_client %}
        <option value="{{ selected_client.code }}"
                data-address="{{ selected_client.address or '' }}"
                data-registred_office="{{ selected_client.registred_office or '' }}"
                selected>
            {{ selected_client.code }} : {{ selected_client.company }}
        </option>
    {% endif %}

    {# 2. Ajouter les autres clients sauf celui s√©lectionn√© #}
    {% for client in clients %}
        {% if not selected_client or client.code != selected_client.code %}
            <option value="{{ client.code }}"
                    data-address="{{ client.address or '' }}"
                    data-registred_office="{{ client.registred_office or '' }}">
                {{ client.code }} : {{ client.company }}
            </option>
        {% endif %}
    {% endfor %}
</select><br><br>



<label for="delivery_location" style="background-color: #FFD580;">Lieu de livraison :</label>
<select name="delivery_location" id="delivery_location"></select><br><br>


<label for="supplier_select" style="background-color: #FFD580;">Ajouter un fournisseur :</label>
<select id="supplier_select">
    <option value="">-- Choisir un fournisseur √† ajouter --</option>
    {% for supplier in suppliers %}
        <option value="{{ supplier.id }}" data-name="{{ supplier.company }}">{{ supplier.code }} : {{ supplier.company }}</option>
    {% endfor %}
</select>
<button type="button" onclick="addSupplierColumn()">Ajouter le fournisseur</button><br><br>

<label for="supplier_remove_select">Supprimer un fournisseur :</label>
<select id="supplier_remove_select">
    <option value="">-- Choisir un fournisseur √† supprimer --</option>
</select>
<button type="button" onclick="removeSelectedSupplier()">Supprimer le fournisseur</button><br><br>

<!-- Conteneur scroll horizontal -->
<div style="overflow-x: auto; width: 100%;">
    <table id="quote_table" style="min-width: 1200px; border-collapse: collapse;">
        <thead>
            <tr id="header_row">
                <th class="blue-column">R√©f. Fourn.</th>
                <th class="move-column">D√©signation</th>
                <th class="blue-column">Quantit√©</th>
                <th class="client-pvc-column" style="background-color: #E0BBE4;">Prix de vente conseill√©</th>
                <th style="background-color: #cce5ff;">Prix de vente client</th>
                <th style="background-color: #FFD580;">Marge (‚Ç¨ / %)</th> 
                <th>Supprimer</th>
            </tr>
        </thead>
        <tbody id="table_body"></tbody>
        <tfoot>
            <tr id="totals_row">
                <td colspan="3" style="font-weight: bold;">Totaux Fournisseurs</td>
                <!-- Ici seront ins√©r√©s dynamiquement les totaux fournisseurs -->
                <td id="total_pvc" class="total-cell"></td>
                <td id="total_vente_client" class="total-cell"></td>
                <td id="total_marge" class="total-cell"></td>
            </tr>
        </tfoot>
    </table>
</div>

<button type="button" onclick="addRow()">Ajouter une ligne</button><br><br>
<label for="selected_supplier_margin">Calculer la marge pour :</label>
<select id="selected_supplier_margin" onchange="updateTotals()">
    <option value="">-- Tous les fournisseurs --</option>
</select><br><br>


<h3>Informations Livraison Fournisseurs</h3>
<table id="supplier_info_table">
    <thead>
        <tr>
            <th>Fournisseur</th>
			<th class="move-column">D√©lai de livraison (j)</th>
			<th class="move-column">Frais de livraison (‚Ç¨)</th>
            <th>Supprimer</th>
        </tr>
    </thead>
    <tbody id="supplier_info_body"></tbody>
</table><br>

<div style="text-align: center; margin-top: 20px;">
    <input type="submit" class="action-button" value="Enregistrer les modifications">
</div>

<div class="action-column">
    <button type="button" class="action-button" onclick="askQuotation()">Demander cotation</button><br>
	<!-- S√©lecteur fournisseur pour demande de cotation -->
<div id="fournisseurSelectContainer" style="display:none; margin-top:10px;">
    <label for="fournisseurSelect">Choisir un fournisseur :</label>
    <select id="fournisseurSelect" class="form-control">
        <option value="">-- S√©lectionner --</option>
        {% for supplier in suppliers %}
            <option value="{{ supplier.id }}"
                    data-email="{{ supplier.email }}"
                    data-name="{{ supplier.company }}">
                {{ supplier.code }} : {{ supplier.company }}
            </option>
        {% endfor %}
    </select>
</div>

	<button type="button" class="action-button" onclick="window.open('{{ url_for('view_quote', quote_id=quote.id) }}', '_blank')">Exporter le devis client</button><br>
    <button type="button" class="action-button" onclick="exportEvoliz()">Exporter vers Evoliz</button>
</div>
</form>
<script>
    window.initialInfos = {{ initial_infos | tojson | safe }};
	
</script>
<script>
  const currentDeliveryLocation = "{{ quote.delivery_location|e }}";

let selectedSuppliers = [];
const initialSuppliers = {{ initial_suppliers|tojson }};
const initialLines = {{ initial_lines|tojson }};

function updateDeliveryLocation() {
    const clientSelect = document.getElementById('client_code');
    const deliverySelect = document.getElementById('delivery_location');

    const address = clientSelect.options[clientSelect.selectedIndex]?.dataset.address || '';
    const registred_office = clientSelect.options[clientSelect.selectedIndex]?.dataset.registred_office || '';

    deliverySelect.innerHTML = '';

    if (address) {
        const option1 = document.createElement('option');
        option1.value = address;
        option1.textContent = address;
        deliverySelect.appendChild(option1);
    }
    if (registred_office && registred_office !== address) {
        const option2 = document.createElement('option');
        option2.value = registred_office;
        option2.textContent = registred_office;
        deliverySelect.appendChild(option2);
    }
    const option3 = document.createElement('option');
    option3.value = 'Linas';
    option3.textContent = 'Linas';
    deliverySelect.appendChild(option3);

    // S√©lectionne la valeur enregistr√©e en base si elle est dans la liste, sinon la premi√®re option
    const optionToSelect = Array.from(deliverySelect.options).find(opt => opt.value === currentDeliveryLocation);

    if (optionToSelect) {
        deliverySelect.value = currentDeliveryLocation;
    } else {
        deliverySelect.selectedIndex = 0;  // Par d√©faut premi√®re option
    }
}

// Initialiser √† la charge de la page
document.addEventListener('DOMContentLoaded', updateDeliveryLocation);


// Fonction pour ajouter une nouvelle ligne
function addRow() {
    const tr = document.createElement('tr');
    let supplierCells = '';

    selectedSuppliers.forEach(s => {
       supplierCells += `
<td>
    <div style="overflow-x: auto; min-width: 220px; max-width: 250px; display: block;">
        <div style="display: flex; flex-direction: column;">

            <!-- Hidden input pour supplier_id -->
            <input type="hidden" name="supplier_id_${s.id}[]" value="${s.id}">

            <!-- Prix fournisseur -->
            Prix fournisseur: <input type="number" name="supplier_price_${s.id}[]" step="0.01" placeholder="Prix ‚Ç¨" value="0.00" oninput="updateTotals()">

            <!-- Remises -->
            <div style="display: flex; gap: 2px; margin-top: 2px;">
                <input type="number" name="supplier_discount_percent_${s.id}[]" step="0.01" placeholder="Remise %" style="width:50%;" oninput="updateTotals()">
                <input type="number" name="supplier_discount_amount_${s.id}[]" step="0.01" placeholder="Remise ‚Ç¨" style="width:50%;" oninput="updateTotals()">
            </div>

            <!-- Prix Net calcul√© -->
            Prix net: <input type="number" name="supplier_net_price_${s.id}[]" step="0.01" placeholder="Prix net ‚Ç¨" value="0.00" readonly style="background-color: #FFD580; margin-top:2px;">

            <!-- Date validit√© promo et quantit√© en stock -->
            <div style="display: flex; flex-direction: column; gap: 2px; margin-top: 2px;">
                <div style="display: flex; align-items: center;">
                    <span style="font-size: 11px; font-weight: 500; white-space: nowrap;">Prix valable jusqu'au :</span>
                    <input type="date" name="supplier_date_validate_promo_${s.id}[]" style="margin-left: auto; width: 50%;">
                </div>
                <div style="display: flex; align-items: center;">
                    <span style="font-size: 11px; font-weight: 500; white-space: nowrap;">Quantit√© en stock :</span>
                    <input type="number" name="supplier_qtt_stock_${s.id}[]" placeholder="Qt√© stock" style="margin-left: auto; width: 50%;">
                </div>
            </div>
        </div>
    </div>
</td>`;
    });

    tr.innerHTML = `
        <input type="hidden" name="line_id[]" value="">
        <td><input type="text" name="supplier_ref[]"  style="width: 200px;"></td>
        <td><input type="text" name="description[]" style="width:300px;height:80px;font-size:16px;padding:5px;" placeholder="Saisissez la description"></td>
        <td><input type="number" name="quantity[]" min="1" value="1" oninput="updateTotals()"></td>
        ${supplierCells}
        <td><input type="number" name="recommended_price[]" step="0.01" value="0.00" oninput="updateTotals()" style="width: 100px;"></td>
        <td><input type="number" name="client_price[]" step="0.01" value="0.00" oninput="updateTotals()" style="width: 100px;"></td>
        <td class="marge-cell"  style="width: 150px;">0.00 ‚Ç¨ / 0.00 %</td>
        <td><button type="button" onclick="deleteRow(this)">üóëÔ∏è</button></td>
    `;
    document.getElementById('table_body').appendChild(tr);
    updateTotals();
}

// Fonction pour ajouter un fournisseur depuis le select
function addSupplierColumn() {
    const select = document.getElementById('supplier_select');
    const supplierId = select.value;
    const supplierName = select.options[select.selectedIndex]?.dataset.name;
    if (!supplierId || selectedSuppliers.find(s => s.id === supplierId)) return;

    addSupplierColumnById(supplierId, supplierName);
}

function addSupplierColumnById(id, name) {
    // Convertir l'id en entier pour √©viter 'undefined' c√¥t√© serveur
    id = parseInt(id);
    if (isNaN(id)) return;

    // V√©rifier si le fournisseur est d√©j√† s√©lectionn√©
    if (selectedSuppliers.find(s => s.id === id)) {
        alert("Ce fournisseur est d√©j√† ajout√© !");
        return;
    }

    selectedSuppliers.push({ id: id, name: name });

    // Ajouter au select pour la marge
    const marginSelect = document.getElementById('selected_supplier_margin');
    if (!marginSelect.querySelector(`option[value="${id}"]`)) {
        const option = document.createElement('option');
        option.value = id;
        option.textContent = name;
        marginSelect.appendChild(option);
    }

    // Ajouter l'en-t√™te dans le tableau
    const headerRow = document.getElementById('header_row');
    const clientPriceTh = headerRow.querySelector('th.client-pvc-column');
    const newTh = document.createElement('th');
    newTh.setAttribute("colspan", "1");
    newTh.innerHTML = `${name}<br><small>Prix + Remises</small>`;
    newTh.classList.add("move-header", `supplier-col-${id}`);
    headerRow.insertBefore(newTh, clientPriceTh);

    // Ajouter cellule total fournisseur
    const totalRow = document.getElementById('totals_row');
    const clientTotalCell = totalRow.querySelector('#total_pvc');
    const newTotalTd = document.createElement('td');
    newTotalTd.classList.add('total-cell');
    newTotalTd.id = `total_fournisseur_${id}`;
    totalRow.insertBefore(newTotalTd, clientTotalCell);

    // Ajouter les cellules pour chaque ligne du devis
    const rows = document.querySelectorAll('#table_body tr');
    rows.forEach(row => {
        const recommendedInput = row.querySelector('input[name="recommended_price[]"]');
        const newTd = document.createElement('td');

        const scroller = document.createElement('div');
        scroller.style.overflowX = 'auto';
        scroller.style.minWidth = '220px';
        scroller.style.maxWidth = '250px';
        scroller.style.display = 'block';

        scroller.innerHTML = `
            <div style="display: flex; flex-direction: column;">
                <input type="hidden" name="supplier_id_${id}[]" value="${id}">
                Prix fournisseur: <input type="number" name="supplier_price_${id}[]" step="0.01" placeholder="Prix ‚Ç¨" value="0.00" oninput="updateTotals()">
                <div style="display: flex; gap: 2px; margin-top: 2px;">
                    <input type="number" name="supplier_discount_percent_${id}[]" step="0.01" placeholder="Remise %" style="width:50%;" oninput="updateTotals()">
                    <input type="number" name="supplier_discount_amount_${id}[]" step="0.01" placeholder="Remise ‚Ç¨" style="width:50%;" oninput="updateTotals()">
                </div>
                Prix net: <input type="number" name="supplier_net_price_${id}[]" step="0.01" placeholder="Prix net ‚Ç¨" value="0.00" readonly style="background-color:#f0f0f0; margin-top:2px;">
                <div style="display: flex; flex-direction: column; gap: 2px; margin-top: 2px;">
                    <div style="display: flex; align-items: center;">
                        <span style="font-size: 11px; font-weight: 500; white-space: nowrap;">Prix valable jusqu'au :</span>
                        <input type="date" name="supplier_date_validate_promo_${id}[]" style="margin-left: auto; width: 50%;">
                    </div>
                    <div style="display: flex; align-items: center;">
                        <span style="font-size: 11px; font-weight: 500; white-space: nowrap;">Quantit√© en stock :</span>
                        <input type="number" name="supplier_qtt_stock_${id}[]" placeholder="Qt√© stock" style="margin-left: auto; width: 50%;">
                    </div>
                </div>
            </div>
        `;

        newTd.appendChild(scroller);
        newTd.classList.add(`supplier-col-${id}`);
        row.insertBefore(newTd, recommendedInput.closest('td'));
    });

    // Ajouter ligne infos fournisseur
    const supplierInfoBody = document.getElementById('supplier_info_body');
    const trInfo = document.createElement('tr');
    trInfo.dataset.supplierId = id;

    const existingInfo = window.initialInfos?.find(info => info.supplier_id == id);
    const deliveryDelay = existingInfo?.delivery_delay ?? 0;
    const deliveryFee = existingInfo?.delivery_fee?.toFixed(2) ?? "0.00";

    trInfo.innerHTML = `
        <td>${name}</td>
        <td><input type="number" name="delivery_delay_${id}" min="0" value="${deliveryDelay}" style="width: 60px;" oninput="highlightBestDelivery()"></td>
        <td><input type="number" name="delivery_fee_${id}" min="0" step="0.01" value="${deliveryFee}" style="width: 80px;" oninput="updateTotals()"></td>
        <td><button type="button" onclick="removeSupplier('${id}')">üóëÔ∏è</button></td>
    `;
    supplierInfoBody.appendChild(trInfo);

    updateSupplierRemoveSelect();
    updateTotals();
}





function removeSupplier(id) {
    // 1. Supprimer la ligne d'infos livraison
    const infoRow = document.querySelector(`#supplier_info_body tr[data-supplier-id="${id}"]`);
    if (infoRow) infoRow.remove();

    // 2. Supprimer l'option dans le s√©lecteur de marge
    const marginSelect = document.getElementById('selected_supplier_margin');
    const option = marginSelect.querySelector(`option[value="${id}"]`);
    if (option) option.remove();


	// 3. Supprimer l'en-t√™te de colonne (th)
	const indexToRemove = selectedSuppliers.findIndex(s => s.id === id);
	if (indexToRemove !== -1) {
		const offset = 3; // Nombre de colonnes fixes avant les colonnes fournisseurs (ex : R√©f, D√©signation, Qt√©)
		const thToRemove = document.querySelector(`#header_row`).children[offset + indexToRemove];
		if (thToRemove) thToRemove.remove();
	}


    // 4. Supprimer la cellule du total fournisseur
    const totalCell = document.getElementById(`total_fournisseur_${id}`);
    if (totalCell) totalCell.remove();

    // 5. Supprimer les colonnes de prix/remises dans chaque ligne de produit
    const rows = document.querySelectorAll('#table_body tr');
    rows.forEach(row => {
        const cells = row.querySelectorAll(`td`);
        cells.forEach(td => {
            if (td.innerHTML.includes(`supplier_price_${id}`) || td.innerHTML.includes(`supplier_discount_percent_${id}`)) {
                td.remove();
            }
        });
    });

    // 6. Retirer de selectedSuppliers[]
    selectedSuppliers = selectedSuppliers.filter(s => s.id !== id);

    updateSupplierRemoveSelect();
    updateTotals();
}




function updateSupplierRemoveSelect() {
    const removeSelect = document.getElementById('supplier_remove_select');
    removeSelect.innerHTML = '<option value="">-- Choisir un fournisseur √† supprimer --</option>';
    selectedSuppliers.forEach(s => {
        const option = document.createElement('option');
        option.value = s.id;
        option.textContent = s.name;
        removeSelect.appendChild(option);
    });
}

function removeSelectedSupplier() {
    const removeSelect = document.getElementById('supplier_remove_select');
    const id = removeSelect.value;
    if (!id) return;

    // Supprimer le th correspondant
    const thToRemove = document.querySelector(`#header_row .supplier-col-${id}`);
    if (thToRemove) thToRemove.remove();

    // Supprimer toutes les td de la colonne correspondante
    document.querySelectorAll('.product-row').forEach(row => {
        const td = row.querySelector(`.supplier-col-${id}`);
        if (td) td.remove();
    });

    // Supprimer la cellule correspondante dans le footer (totaux)
    const totalTd = document.querySelector(`.total-row .supplier-col-${id}`);
    if (totalTd) totalTd.remove();

    // Supprimer du tableau JS des fournisseurs s√©lectionn√©s
    removeSupplier(id);
}


function getSupplierNameById(id) {
    const sup = selectedSuppliers.find(s => s.id === id);
    return sup ? sup.name : id;
}

function deleteRow(button) {
    button.closest('tr').remove();
    updateTotals();
}

function rebuildTable() {
    // Vide le tbody
    const tbody = document.getElementById('table_body');
    tbody.innerHTML = '';

    // Reconstruire les lignes (recr√©ation compl√®te car on a supprim√© une colonne)
    // Ici on pourrait stocker les donn√©es et les re-injecter,
    // mais pour simplifier on part d'un tableau vide
}
function updateTotals() {
    const rows = document.querySelectorAll('#table_body tr');

    const supplierTotals = {};
    selectedSuppliers.forEach(s => {
        supplierTotals[s.id] = 0;
    });

    let totalVenteClient = 0;
    let totalPVC = 0;
    let totalMarge = 0;

    rows.forEach(row => {
        const qty = parseFloat(row.querySelector('input[name="quantity[]"]').value) || 0;
        const clientPriceInput = row.querySelector('input[name="client_price[]"]');
        const clientPrice = parseFloat(clientPriceInput.value) || 0;
        totalVenteClient += clientPrice * qty;

        const recommendedPriceInput = row.querySelector('input[name="recommended_price[]"]');
        const recommendedPrice = parseFloat(recommendedPriceInput.value) || 0;
        totalPVC += recommendedPrice * qty;

        let bestSupplierPrice = null;
        let bestSupplierId = null;

        selectedSuppliers.forEach(s => {
            const priceInput = row.querySelector(`input[name="supplier_price_${s.id}[]"]`);
            const netInput = row.querySelector(`input[name="supplier_net_price_${s.id}[]"]`);
            const percentInput = row.querySelector(`input[name="supplier_discount_percent_${s.id}[]"]`);
            const amountInput = row.querySelector(`input[name="supplier_discount_amount_${s.id}[]"]`);

            let price = parseFloat(priceInput?.value) || 0;
            const remPercent = parseFloat(percentInput?.value) || 0;
            const remAmount = parseFloat(amountInput?.value) || 0;

            let priceAfterDiscount = price;
            if (remPercent > 0) priceAfterDiscount *= (1 - remPercent / 100);
            if (remAmount > 0) priceAfterDiscount -= remAmount;
            if (priceAfterDiscount < 0) priceAfterDiscount = 0;

            // Mettre √† jour le prix net
            if (netInput) netInput.value = priceAfterDiscount.toFixed(2);

            const deliveryFeeInput = document.querySelector(`input[name="delivery_fee_${s.id}"]`);
            const deliveryFee = deliveryFeeInput ? parseFloat(deliveryFeeInput.value) || 0 : 0;

            let totalQtyForSupplier = 0;
            rows.forEach(r => {
                const q = parseFloat(r.querySelector('input[name="quantity[]"]').value) || 0;
                const p = r.querySelector(`input[name="supplier_price_${s.id}[]"]`);
                if (p) totalQtyForSupplier += q;
            });

            const feePerUnit = totalQtyForSupplier > 0 ? deliveryFee / totalQtyForSupplier : 0;
            const unitCostWithDelivery = priceAfterDiscount + feePerUnit;
            const totalPrice = unitCostWithDelivery * qty;

            supplierTotals[s.id] += totalPrice;

            // Nettoyer les classes "best"
            selectedSuppliers.forEach(sup => {
                const cell = row.querySelector(`input[name="supplier_price_${sup.id}[]"]`)?.closest('td');
                if (cell) cell.classList.remove('best-cell');
            });

            if (bestSupplierPrice === null || priceAfterDiscount < bestSupplierPrice) {
                bestSupplierPrice = priceAfterDiscount;
                bestSupplierId = s.id;
            }
        });

        // Calcul de la marge
        const selectedSupplierId = document.getElementById('selected_supplier_margin').value;
        const margeCell = row.querySelector('.marge-cell');

        if (selectedSupplierId && bestSupplierPrice !== null) {
            const priceInput = row.querySelector(`input[name="supplier_price_${selectedSupplierId}[]"]`);
            const percentInput = row.querySelector(`input[name="supplier_discount_percent_${selectedSupplierId}[]"]`);
            const amountInput = row.querySelector(`input[name="supplier_discount_amount_${selectedSupplierId}[]"]`);

            if (priceInput) {
                let price = parseFloat(priceInput.value) || 0;
                const remPercent = parseFloat(percentInput?.value) || 0;
                const remAmount = parseFloat(amountInput?.value) || 0;

                let priceAfterDiscount = price;
                if (remPercent > 0) priceAfterDiscount *= (1 - remPercent / 100);
                if (remAmount > 0) priceAfterDiscount -= remAmount;
                if (priceAfterDiscount < 0) priceAfterDiscount = 0;

                const deliveryFeeInput = document.querySelector(`input[name="delivery_fee_${selectedSupplierId}"]`);
                const deliveryFee = deliveryFeeInput ? parseFloat(deliveryFeeInput.value) || 0 : 0;

                let totalQtyForSupplier = 0;
                rows.forEach(r => {
                    const q = parseFloat(r.querySelector('input[name="quantity[]"]').value) || 0;
                    const p = r.querySelector(`input[name="supplier_price_${selectedSupplierId}[]"]`);
                    if (p) totalQtyForSupplier += q;
                });

                const feePerUnit = totalQtyForSupplier > 0 ? deliveryFee / totalQtyForSupplier : 0;

                const fullCost = priceAfterDiscount + feePerUnit;
                const margeValue = clientPrice - fullCost;
                const margePercent = clientPrice > 0 ? (margeValue / clientPrice) * 100 : 0;

                margeCell.textContent = `${margeValue.toFixed(2)} ‚Ç¨ / ${margePercent.toFixed(1)} %`;
                totalMarge += margeValue * qty;
            } else {
                margeCell.textContent = "N/A";
            }
        } else {
            margeCell.textContent = "N/A";
        }
    });

    // Totaux par fournisseur
    selectedSuppliers.forEach(s => {
        const cell = document.getElementById(`total_fournisseur_${s.id}`);
        const feeInput = document.querySelector(`input[name="delivery_fee_${s.id}"]`);
        const deliveryFee = feeInput ? parseFloat(feeInput.value) || 0 : 0;
        if (cell) {
            cell.textContent = `${supplierTotals[s.id].toFixed(2)} ‚Ç¨ (dont ${deliveryFee.toFixed(2)} ‚Ç¨ livraison)`;
        }
    });

    // Totaux g√©n√©raux
    document.getElementById('total_pvc').textContent = totalPVC.toFixed(2) + " ‚Ç¨";
    document.getElementById('total_vente_client').textContent = totalVenteClient.toFixed(2) + " ‚Ç¨";
    document.getElementById('total_marge').textContent = totalMarge.toFixed(2) + " ‚Ç¨";

    highlightBestPriceSupplier();
    highlightBestDelivery();
}




function highlightBestPriceSupplier() {
    // Met en vert la cellule fournisseur avec le prix total le plus bas dans le tableau
    let minTotal = null;
    let minSupplierId = null;
    selectedSuppliers.forEach(s => {
        const totalCell = document.getElementById(`total_fournisseur_${s.id}`);
        if (totalCell) {
            const val = parseFloat(totalCell.textContent) || null;
            if (val !== null && (minTotal === null || val < minTotal)) {
                minTotal = val;
                minSupplierId = s.id;
            }
        }
    });
    // Supprime tous les surlignages
    selectedSuppliers.forEach(s => {
        const rows = document.querySelectorAll(`#table_body tr`);
        rows.forEach(row => {
            const input = row.querySelector(`input[name="supplier_price_${s.id}[]"]`);
            if(input) input.closest('td').classList.remove('best-cell');
        });
        const totalCell = document.getElementById(`total_fournisseur_${s.id}`);
        if(totalCell) totalCell.classList.remove('best-cell');
    });
    if(minSupplierId) {
        // Surligne toutes les cellules de ce fournisseur
        const rows = document.querySelectorAll(`#table_body tr`);
        rows.forEach(row => {
            const input = row.querySelector(`input[name="supplier_price_${minSupplierId}[]"]`);
            if(input) input.closest('td').classList.add('best-cell');
        });
        const totalCell = document.getElementById(`total_fournisseur_${minSupplierId}`);
        if(totalCell) totalCell.classList.add('best-cell');
    }
}
function highlightBestDelivery() {
  const supplierInfoBody = document.getElementById('supplier_info_body');
  if (!supplierInfoBody) return;

  // Trouver le fournisseur qui a la classe 'best-cell' dans la table des prix
  // (on cherche la cellule total du fournisseur dans highlightBestPriceSupplier)
  let bestSupplierId = null;
  selectedSuppliers.forEach(s => {
    const totalCell = document.getElementById(`total_fournisseur_${s.id}`);
    if (totalCell && totalCell.classList.contains('best-cell')) {
      bestSupplierId = s.id;
    }
  });

  // Enlever toutes les couleurs de fond dans supplier_info_body
  [...supplierInfoBody.children].forEach(tr => {
    tr.style.backgroundColor = '';
  });

  if (bestSupplierId) {
    // Surligner en vert le fournisseur qui correspond au bestSupplierId
    const bestTr = supplierInfoBody.querySelector(`tr[data-supplier-id="${bestSupplierId}"]`);
    if (bestTr) bestTr.style.backgroundColor = '#90ee90';
  }
}



function askQuotation() {
    alert("Fonction Demander cotation √† impl√©menter");
}
function createWord() {
    alert("Fonction Cr√©er un fichier Word √† impl√©menter");
}
function exportEvoliz() {
    alert("Fonction Exporter vers Evoliz √† impl√©menter");
}

document.addEventListener('DOMContentLoaded', () => {
    updateDeliveryLocation();

    // 1. Charger les fournisseurs d√©j√† pr√©sents
    initialSuppliers.forEach(supplier => {
        addSupplierColumnById(supplier.id, supplier.name);
    });
// 2. Ajouter les lignes existantes
initialLines.forEach(line => {
    const tr = document.createElement('tr');

    let supplierCells = '';
    selectedSuppliers.forEach(s => {
        const sp = line.supplier_prices.find(p => p.supplier_id === s.id) || {};
        supplierCells += `
            <td>
                <div style="overflow-x: auto; min-width: 220px; max-width: 250px; display: block;">
                    <div style="display: flex; flex-direction: column;">
                        <!-- hidden input pour supplier_id -->
                        <input type="hidden" name="supplier_id_${s.id}[]" value="${s.id}">

                        <!-- Prix fournisseur -->
                        Prix fournisseur: <input type="number" name="supplier_price_${s.id}[]" step="0.01" placeholder="Prix ‚Ç¨" value="${sp.price ?? 0}" oninput="updateTotals()">
                        
                        <!-- Remises -->
                        <div style="display: flex; gap: 2px; margin-top: 2px;">
                            <input type="number" name="supplier_discount_percent_${s.id}[]" step="0.01" placeholder="Remise %" value="${sp.discount_percent ?? ''}" style="width:50%;" oninput="updateTotals()">
                            <input type="number" name="supplier_discount_amount_${s.id}[]" step="0.01" placeholder="Remise ‚Ç¨" value="${sp.discount_amount ?? ''}" style="width:50%;" oninput="updateTotals()">
                        </div>

                        <!-- Prix net apr√®s remises -->
                        Prix net: <input type="number" name="supplier_net_price_${s.id}[]" step="0.01" placeholder="Prix net ‚Ç¨" value="0.00" readonly style="margin-top:2px; background-color: #FFD580;">
                        
                        <!-- Date validit√© promo et quantit√© en stock -->
                        <div style="display: flex; flex-direction: column; gap: 2px; margin-top: 2px;">
                            <div style="display: flex; align-items: center;">
                                <span style="font-size: 11px; font-weight: 500; white-space: nowrap;">Prix valable jusqu'au :</span>
                                <input type="date" name="supplier_date_validate_promo_${s.id}[]" value="${sp.date_validate_promo ?? ''}" style="margin-left: auto; width: 50%;">
                            </div>
                            <div style="display: flex; align-items: center;">
                                <span style="font-size: 11px; font-weight: 500; white-space: nowrap;">Quantit√© en stock :</span>
                                <input type="number" name="supplier_qtt_stock_${s.id}[]" value="${sp.qtt_stock ?? ''}" style="margin-left: auto; width: 50%;">
                            </div>
                        </div>
                    </div>
                </div>
            </td>`;
    });

    tr.innerHTML = `
        <input type="hidden" name="line_id[]" value="${line.id}">
        <td><input type="text" name="supplier_ref[]" value="${line.supplier_ref ?? ''}"  style="width: 150px;"></td>
        <td><input type="text" name="description[]" value="${line.description ?? ''}" style="width:300px;height:80px;font-size:16px;padding:5px;" placeholder="Saisissez la description"></td>
        <td><input type="number" name="quantity[]" value="${line.quantity ?? 1}" min="1" oninput="updateTotals()"></td>
        ${supplierCells}
        <td><input type="number" step="0.01" class="form-control" name="recommended_price[]" value="${line.recommended_price ?? 0}" oninput="updateTotals()" style="width: 100px;"></td>
        <td><input type="number" step="0.01" class="form-control" name="client_price[]" value="${line.client_price ?? 0}" oninput="updateTotals()" style="width: 100px;"></td>
        <td class="marge-cell" style="width: 150px;">0.00 ‚Ç¨ / 0.00 %</td>
        <td><button type="button" onclick="deleteRow(this)">üóëÔ∏è</button></td>
    `;

    document.getElementById('table_body').appendChild(tr);
});


// Mettre √† jour les totaux apr√®s avoir ajout√© toutes les lignes
updateTotals();


    // 3. Ajouter les infos livraison
initialInfos.forEach(info => {
    const tr = document.createElement('tr');
    tr.dataset.supplierId = info.supplier_id;
    const supplierName = getSupplierNameById(info.supplier_id);

    document.getElementById('supplier_info_body').appendChild(tr);
});


    updateTotals();
});


// D√©finit la date de cr√©ation au chargement de la page (format AAAA-MM-JJ pour MySQL)
document.addEventListener("DOMContentLoaded", function() {
    const input = document.getElementById("creation_date");
    if (!input.value) {  // ne change que si la valeur est vide
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        input.value = `${year}-${month}-${day}`;
    }
});


</script>

<script>
  document.addEventListener('DOMContentLoaded', () => {
  // Fonction commune pour g√©rer la touche Entr√©e dans un tbody donn√©
  function handleEnterKeyOnTable(tbodyId) {
    const tbody = document.getElementById(tbodyId);
    if (!tbody) return;

    tbody.addEventListener('keydown', (event) => {
      if (event.key === 'Enter') {
        event.preventDefault();

        const inputs = Array.from(tbody.querySelectorAll('input, select, textarea'));
        const currentIndex = inputs.indexOf(event.target);

        if (currentIndex > -1) {
          const nextInput = inputs[currentIndex + 1];
          if (nextInput) {
            nextInput.focus();
          }
        }
      }
    });
  }

  // Appliquer sur le tableau principal
  handleEnterKeyOnTable('table_body');

  // Appliquer sur le tableau Livraison Fournisseurs
  handleEnterKeyOnTable('supplier_info_body');

  // √âcouter les modifications des frais de livraison (seulement si > 0)
  document.querySelectorAll('input[name^="delivery_fee_"]').forEach(input => {
    input.addEventListener('input', (e) => {
      const val = parseFloat(e.target.value);
      if (!isNaN(val) && val > 0) {
        updateTotals();
      } else {
        // Si valeur nulle ou vide, on peut forcer la mise √† jour pour retirer la surbrillance
        updateTotals();
      }
    });
  });
});
</script>
<script>
// Inject√© par Jinja ‚Äî tout est pr√™t √† l‚Äôemploi c√¥t√© JS
const initialSuppliers = {{ initial_suppliers|tojson }};   // [{id:"FOU01", name:"Fournisseur¬†1"}, ...]
const initialLines     = {{ initial_lines|tojson }};       // voir ¬ß‚ÄØJS
const initialInfos     = {{ initial_infos|tojson }};       // d√©lais/frais livraison
$('#updateProductForm').on('submit', function (e) {
  $(this).find('input[name="recommended_price[]"]').each(function () {
    console.log('recommended_price:', $(this).val());
  });
});

</script>
<script>
  flatpickr("#creation_date", {
    dateFormat: "Y-m-d",      // Format affich√© √† l'utilisateur
    altInput: false,          // Pas de champ secondaire
    locale: "fr",             // Langue fran√ßaise
    allowInput: true          // Permet la saisie manuelle
  });
</script>
<script>
function askQuotation() {
    // Afficher le conteneur du select
    const container = document.getElementById('fournisseurSelectContainer');
    container.style.display = 'block';

    const select = document.getElementById('fournisseurSelect');

    // 1) IDs des fournisseurs rattach√©s au devis (quote_id courant)
    const initialInfos = {{ initial_infos | tojson }}; // [{id, supplier_id, delivery_delay, ...}, ...]
    const attachedIds = initialInfos.map(i => String(i.supplier_id));

    // 2) Tous les fournisseurs (id/id + nom + email) -> on les construit c√¥t√© template
    const allSuppliers = [
        {% for s in suppliers %}
        {"id":"{{ s.id }}","name":"{{ (s.company or s.id)|e }}","email":"{{ (s.email or '')|e }}"},
        {% endfor %}
    ];

    // 3) Ne garder que ceux li√©s √† CE devis (pr√©sents dans quote.supplier_info)
    const attachedSuppliers = allSuppliers.filter(s => attachedIds.includes(String(s.id)));

    // 4) Remplir le <select> UNIQUEMENT avec ces fournisseurs
    select.innerHTML = '<option value="">-- S√©lectionner --</option>';
    attachedSuppliers.forEach(s => {
        const opt = document.createElement('option');
        opt.value = s.id;
        opt.textContent = s.name || s.id;
        if (s.email) opt.dataset.email = s.email;
        select.appendChild(opt);
    });

    // 5) √âviter les doublons de listeners si la fonction est rappel√©e
    select.onchange = null;

    // 6) Au changement, pr√©parer le mail
    select.onchange = function () {
        const selected = select.options[select.selectedIndex];
        const email = selected?.dataset?.email || '';
        if (!email) {
            alert("‚ö†Ô∏è Ce fournisseur n‚Äôa pas d‚Äôemail enregistr√©.");
            return;
        }

        const devisNum = "{{ quote.quote_number }}";

        // R√©cup√©rer le contenu du tableau
        const produits = [];
        document.querySelectorAll('#table_body tr').forEach(tr => {
            const ref = tr.querySelector('input[name="supplier_ref[]"]')?.value || '';
            const designation = tr.querySelector('input[name="description[]"]')?.value || '';
            const quantite = tr.querySelector('input[name="quantity[]"]')?.value || '0';
            produits.push({ ref, designation, quantite });
        });

        // Corps du mail
        let corps = "Bonjour,\n\n";
        corps += "Je me permets de vous contacter dans le cadre d‚Äôun devis que nous pr√©parons pour un client. Nous souhaiterions obtenir votre meilleure offre pour les produits suivants :\n\n";
        produits.forEach(p => {
            corps += `${p.quantite} Produit${Number(p.quantite) > 1 ? 's' : ''} de R√©f√©rence ${p.ref}: ${p.designation}\n`;
        });
        corps += "\nMerci de bien vouloir nous communiquer vos conditions, notamment les √©ventuelles remises en euros ou en pourcentage :\n";
        corps += "Remise (‚Ç¨) : __________\nRemise (%) : __________\n\n";
        corps += "Cordialement,\nAtlantis Evolution";

        // Lancer le mail
        const mailtoLink = `mailto:${email}?subject=${encodeURIComponent('Demande cotation - Atlantis Evolution - ' + devisNum)}&body=${encodeURIComponent(corps)}`;
        window.location.href = mailtoLink;
    };
}
</script>



</body>
</html>
{% endblock %}
