{% extends "base.html" %}
{% block content %}
<style>
  body {
    font-family: Arial, sans-serif;
    color: #333;
  }
  .devis-container {
    max-width: 900px;
    margin: auto;
    padding: 30px;
    background: white;
    border: 1px solid #ccc;
  }
  .header {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .header img {
    height: 60px;
  }
  .devis-title {
    text-align: center;
    font-size: 28px;
    margin: 20px 0;
    font-weight: bold;
    text-transform: uppercase;
    border-bottom: 2px solid #000;
    padding-bottom: 10px;
  }
  .section {
    margin-top: 30px;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
  }
  th, td {
    padding: 8px;
    border: 1px solid #ccc;
    text-align: left;
    vertical-align: top;
  }
  th {
    background-color: #f2f2f2;
  }
  .totaux {
    font-weight: bold;
    background-color: #f9f9f9;
  }
  .footer-note {
    margin-top: 50px;
    font-size: 12px;
    color: #777;
    border-top: 1px solid #ddd;
    padding-top: 15px;
    text-align: center;
  }
</style>

<div class="devis-container">
  <!-- En-t√™te -->
  <div class="header">
    <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Logo" id="logo-img">
    <div>
      <strong>Devis n¬∞ :</strong> {{ quote.quote_number }}<br>
      <strong>Date :</strong> {{ quote.creation_date.strftime("%d/%m/%Y") }}
    </div>
  </div>

  <div class="devis-title">Devis client</div>

  <!-- Infos client -->
  <div class="section">
    <h3>Informations client</h3>
    <p><strong>Client :</strong> {{ quote.client.code }} - {{ quote.client.company }}</p>
    <p><strong>Adresse :</strong> {{ quote.client.address }}</p>
    <p><strong>Lieu de livraison :</strong> {{ quote.delivery_location }}</p>
  </div>

  {% if quote_incomplete %}
  <div class="alert alert-warning mt-3">
      ‚ö†Ô∏è Ce devis n'est pas compl√©t√© : aucun prix fournisseur n‚Äôa √©t√© saisi.<br>
      <a href="{{ url_for('edit_quote', quote_id=quote.id) }}" class="btn btn-warning btn-sm mt-2">
          ‚úé Modifier / Compl√©ter le devis
      </a>
  </div>
  {% endif %}

  <!-- Lignes de devis -->
  <div class="section">
    <h3>D√©tails du devis</h3>
    <table id="devis-table">
      <thead>
        <tr>
          <th>R√©f.</th>
          <th>Description</th>
          <th>Quantit√©</th>
          <th>Prix unitaire (‚Ç¨)</th>
          <th>Total (‚Ç¨)</th>
        </tr>
      </thead>
      <tbody>
        {% for line in initial_lines %}
        {% set total_line = line.client_price * line.quantity %}
        <tr>
          <td>{{ line.supplier_ref }}</td>
          <td>{{ line.description }}</td>
          <td>{{ line.quantity }}</td>
          <td>{{ "%.2f"|format(line.client_price) }} ‚Ç¨</td>
          <td class="total-cell">{{ "%.2f"|format(total_line) }} ‚Ç¨</td>
        </tr>
        {% endfor %}
      </tbody>
      <tfoot>
        <tr class="totaux">
          <td colspan="4" style="text-align: right;">Total</td>
          <td id="total-js">0.00 ‚Ç¨</td>
        </tr>
      </tfoot>
    </table>
  </div>

  <!-- Livraison fournisseur -->
  <div class="section">
    <h3>Informations de livraison</h3>
    {% if initial_suppliers %}
      {% set chosen_supplier = initial_suppliers[0] %}
      {% set infos_fournisseur = initial_infos | selectattr("supplier_id", "equalto", chosen_supplier.id) | list %}
      {% if infos_fournisseur %}
        {% for info in infos_fournisseur %}
          <p><strong>D√©lai livraison (jours) :</strong> {{ info.delivery_delay }}</p>
          <p><strong>Frais livraison (‚Ç¨) :</strong> {{ "%.2f"|format(info.delivery_fee) }} ‚Ç¨</p>
        {% endfor %}
      {% else %}
        <p>Aucune information de livraison disponible pour le fournisseur s√©lectionn√©.</p>
      {% endif %}
    {% else %}
      <p>Aucun fournisseur s√©lectionn√© pour ce devis.</p>
    {% endif %}
  </div>

  <!-- Pied de page -->
  <div class="footer-note">
    Conditions g√©n√©rales de vente disponibles sur demande. Merci de votre confiance.
  </div>
</div>

<!-- Boutons export hors de la div .devis-container -->
<div style="margin: 30px auto; text-align: center;">
  <button id="exportPdfBtn" style="padding: 10px 15px; font-size: 16px;">üìë Exporter en PDF</button>
  <button id="exportWordBtn" style="padding: 10px 15px; font-size: 16px;">üìÑ Exporter en Word</button>
</div>

<!-- Librairies n√©cessaires -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
  // Calcul total JS
  function calculerTotalJS() {
    const totalCells = document.querySelectorAll('#devis-table tbody .total-cell');
    let totalJS = 0;
    totalCells.forEach(cell => {
      const valStr = cell.textContent.replace(' ‚Ç¨', '').replace(',', '.');
      const valNum = parseFloat(valStr);
      if (!isNaN(valNum)) totalJS += valNum;
    });
    totalJS = Math.round((totalJS + Number.EPSILON) * 100) / 100;
    document.getElementById('total-js').textContent = totalJS.toFixed(2) + ' ‚Ç¨';
  }
  window.addEventListener('DOMContentLoaded', () => calculerTotalJS());

  // Fonction utilitaire pour convertir le logo en base64
  function toDataURL(url, callback) {
    var xhr = new XMLHttpRequest();
    xhr.onload = function() {
      var reader = new FileReader();
      reader.onloadend = function() {
        callback(reader.result);
      }
      reader.readAsDataURL(xhr.response);
    };
    xhr.responseType = 'blob';
    xhr.open('GET', url);
    xhr.send();
  }

  // Export Word
  document.getElementById('exportWordBtn').addEventListener('click', function () {
    const logoURL = "{{ url_for('static', filename='images/logo.png') }}";
    toDataURL(logoURL, function(base64Img){
      let styles = '';
      document.querySelectorAll('style').forEach(styleTag => { styles += styleTag.outerHTML; });

      const container = document.querySelector('.devis-container').cloneNode(true);
      const img = container.querySelector('img#logo-img');
      if(img) img.src = base64Img;

      // Supprime les boutons avant export
      container.querySelectorAll('#exportWordBtn, #exportPdfBtn').forEach(btn => btn.remove());

      const contentHTML = container.outerHTML;
      const header = `
        <html xmlns:o='urn:schemas-microsoft-com:office:office'
              xmlns:w='urn:schemas-microsoft-com:office:word'
              xmlns='http://www.w3.org/TR/REC-html40'>
          <head><meta charset='utf-8'><title>Devis</title>${styles}</head>
          <body>`;
      const footer = `</body></html>`;
      const sourceHTML = header + contentHTML + footer;

      const blob = new Blob(['\ufeff', sourceHTML], { type: 'application/msword' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = 'devis_{{ quote.quote_number }}.doc';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    });
  });

  // Export PDF
  document.getElementById('exportPdfBtn').addEventListener('click', function () {
    const { jsPDF } = window.jspdf;
    const container = document.querySelector('.devis-container');

    html2canvas(container, { scale: 2, useCORS: true }).then(canvas => {
      const imgData = canvas.toDataURL('image/png');
      const pdf = new jsPDF('p', 'mm', 'a4');

      const pageWidth = pdf.internal.pageSize.getWidth();
      const pageHeight = pdf.internal.pageSize.getHeight();
      const imgWidth = pageWidth;
      const imgHeight = (canvas.height * imgWidth) / canvas.width;

      if (imgHeight < pageHeight) {
        pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
      } else {
        let heightLeft = imgHeight;
        let position = 0;
        while (heightLeft > 0) {
          pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
          heightLeft -= pageHeight;
          position -= pageHeight;
          if (heightLeft > 0) pdf.addPage();
        }
      }
      pdf.save('devis_{{ quote.quote_number }}.pdf');
    });
  });
</script>
{% endblock %}
